<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<title>开封市电动自行车头盔佩戴专项整治</title>
		<script src="js/angular.min.js"></script>
		<script src="js/layer-v3.1.1/layer/mobile/layer.js"></script>
		<script src="js/common.js"></script>
		<link rel="stylesheet" type="text/css" href="css/app.css" />
	</head>
	<body>

		<div class="bg">
			<div id="" class="form" ng-app="myApp" ng-controller="loginCtrl">
				<div class="title_card">车牌号：</div>
				<div class="line">
					<div class="city">开封·</div>
					<input id="cardNo" class="cardNo_input" type="number" pattern="\d*" placeholder="请输入车牌号" ng-model='cardNo'
						value="" />
				</div>
				<div class="title">姓名：<a style="color: red;">*</a></div>
				<div class="line">
					<input id="username" class="form_input" type="text" required placeholder="请输入姓名" ng-model='username'
						value="" />
				</div>
				<div class="title">手机号：<a style="color: red;">*</a></div>
				<div class="line">
					<input id="phone" class="form_input" type="tel" maxlength="11" placeholder="请输入手机号"
						ng-model='phone' value="" />
				</div>
				<div class="title">违规地点：<a style="color: red;">*</a></div>
				<div class="row">
					<div id="address" class="address"></div>
					<img class="address-img" src="img/address.png" onclick="onLocation()" />
				</div>
				<div class="title">是否租借头盔：</div>
				<select id="select" class="select"
					onchange="gradeChange(this.options[this.options.selectedIndex].value)">
					<option value="0">否</option>
					<option value="1">是</option>
				</select>
				<div id="submit" class="btn" ng-click="checkSubmit()"> 提 交 </div>
			</div>
		</div>


	</body>
	<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=C93b5178d7a8ebdb830b9b557abce78b">
	</script>
	<script src="js/jquery-3.5.1.min.js"></script>
	<script>
		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showPosition, showError);
			} else {
				alert("浏览器不支持地理定位。");
			}
		}

		function showPosition(position) {
			console.log(position);
			var lat = position.coords.latitude; //纬度 
			var lng = position.coords.longitude; //经度 
			console.log('纬度:' + lat + ',经度:' + lng);

			// 系统坐标转百度经纬度
			const pointBak = new BMap.Point(lng, lat);
			const convertor = new BMap.Convertor();
			convertor.translate([pointBak], 1, 5, function(resPoint) {
				if (resPoint && resPoint.points && resPoint.points.length > 0) {
					lng = resPoint.points[0].lng;
					lat = resPoint.points[0].lat;
				}
				const point = new BMap.Point(lng, lat);
				const geo = new BMap.Geocoder();
				geo.getLocation(point, (res) => {

					//将我们获取到的经纬度保存到变量中
					var latlon = res.point.lat + ',' + res.point.lng;

					// baidu接口
					var url =
						"https://api.map.baidu.com/geocoder/v2/?ak=C93b5178d7a8ebdb830b9b557abce78b&location=" +
						latlon + "&output=json&pois=0"
					$.ajax({
						type: "GET",
						dataType: "jsonp",
						url: url,
						beforeSend: function() {
							$("#address").html('正在定位...');
						},
						success: function(res) {
							if (res.status == 0) {
								$("#address").html(res.result.formatted_address);
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown) {
							$("#address").html("地址位置获取失败");
						}
					});

				});
			});

		}

		function showError(error) {
			switch (error.code) {
				case error.PERMISSION_DENIED:
					alert("定位失败,用户拒绝请求地理定位");
					break;
				case error.POSITION_UNAVAILABLE:
					alert("定位失败,位置信息是不可用");
					break;
				case error.TIMEOUT:
					alert("定位失败,请求获取用户位置超时");
					break;
				case error.UNKNOWN_ERROR:
					alert("定位失败,定位系统失效");
					break;
			}
		}



		// 点击定位
		function onLocation() {
			console.log('点击定位')
			this.getLocation()
		}

		// 选择租借头盔
		function gradeChange(tx) {
			// alert(tx);
			console.log(tx)
		}

		// 清空输入内容
		function clearData() {
			$(document).ready(function() {
				$("#submit").click(function() {
					$("#cardNo").val('');
					$("#username").val('');
					$("#phone").val('');
				});
			});
		}


		// 获取url参数
		function getQueryVariable(variable) {
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i = 0; i < vars.length; i++) {
				var pair = vars[i].split("=");
				if (pair[0] == variable) {
					return pair[1];
				}
			}
			return (false);
		}

		// 点击提交
		var app = angular.module('myApp', []);
		app.controller('loginCtrl', function($scope, $http, $rootScope) {
			$scope.checkSubmit = function() {


				if (!$scope.username || $scope.username == '') {
					common.toast({
						message: '请输入用户名'
					})
					return false
				}

				if (!$scope.phone || $scope.phone == '') {
					common.toast({
						message: '请输入手机号'
					})
					return false
				}

				if ($scope.phone.length != 11) {
					common.toast({
						message: '请输入正确的手机号码'
					})
					return false
				}

				var address = document.getElementById("address").innerHTML

				if (!address || address == '') {
					common.toast({
						message: '请选择违规地点'
					})
					return false
				}
				

				var police_id = 1;
				police_id = window.getQueryVariable("police_id")

				// 选择是否租借头盔
				var is_helmet = 0;
				var select = document.getElementById("select");
				is_helmet = select.selectedIndex

				$.ajax({
					type: 'POST',
					url: "https://mini.tangdoush.com/api/police/policeMessage",
					contentType: 'application/json',
					async: true,
					dataType: 'JSON',
					contentType: 'application/x-www-form-urlencoded;charset=utf-8',
					data: {
						police_id: police_id,
						ebike_number: $scope.cardNo,
						user_name: $scope.username,
						user_mobile: $scope.phone,
						address: address,
						is_helmet: is_helmet,
					},
					beforeSend: function() {
						//3.设置提交按钮失效，以实现防止按钮重复点击
						$("#submit").attr('disabled', true);
					},
					complete: function() {
						//5.提交完成后按钮重新设置有效
						$("#submit").removeAttr('disabled');
					},
					success: function(res) {
						console.log(res)
						if (res.code == 1) {
							window.location.href = 'success.html?ebike_number='+$scope.cardNo+'&user_name='+$scope.username+'&user_mobile='+$scope.phone+'&address='+address+'' 
							$("#cardNo").val('');
							$("#username").val('');
							$("#phone").val('');
						} else {
							common.toast({
								title: res.msg
							});
						}

					}
				});

			}
		});
	</script>

</html>
